<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Ranger OAuth2 + JWT í†µí•© í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
          font-family: 'Segoe UI', sans-serif;
          text-align: center;
          margin-top: 60px;
          color: #333;
          padding-bottom: 50px;
        }
        h1 { font-size: 26px; margin-bottom: 20px; }

        /* ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .btn {
          display: inline-block;
          width: 220px;
          padding: 12px 16px;
          margin: 6px;
          border-radius: 6px;
          border: none;
          font-size: 15px;
          cursor: pointer;
          transition: transform 0.1s ease-in-out;
          color: #fff;
          font-weight: 500;
          text-decoration: none; /* ë§í¬ ë°‘ì¤„ ì œê±° */
        }
        .btn:hover { transform: scale(1.03); }

        /* ì†Œì…œ ë¡œê·¸ì¸ ë²„íŠ¼ ìƒ‰ìƒ */
        .google   { background-color: #DB4437; }
        .naver    { background-color: #1EC800; }
        .kakao    { background-color: #FEE500; color: #3C1E1E; }
        .facebook { background-color: #1877F2; }

        /* ê¸°ëŠ¥ ë²„íŠ¼ ìƒ‰ìƒ */
        .action   { background-color: #444; }
        .danger   { background-color: #E74C3C; } /* íšŒì›íƒˆí‡´ìš© ë¶‰ì€ìƒ‰ */

        /* ìƒíƒœ í‘œì‹œ ì˜ì—­ */
        .status {
          margin-top: 30px;
          font-size: 14px;
          color: #555;
          white-space: pre-line;
          font-weight: bold;
        }

        /* API ê²°ê³¼ ë¡œê·¸ ì°½ (JSON ì¶œë ¥ìš©) */
        pre {
          text-align: left;
          display: inline-block;
          background: #f6f6f6;
          border: 1px solid #ddd;
          border-radius: 8px;
          padding: 16px;
          width: 80%;
          max-width: 800px;
          overflow-x: auto;
          line-height: 1.5;
          margin-top: 20px;
          min-height: 50px;
          color: #333;
        }

        /* íšŒì›íƒˆí‡´ ì„±ê³µ ë©”ì‹œì§€ ë°•ìŠ¤ */
        #withdrawSuccess {
            display: none;
            margin: 20px auto;
            width: 80%;
            max-width: 800px;
            padding: 18px;
            background: #e8f8f0;
            color: #2c7a4b;
            border: 1px solid #b6e2c3;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
        }

        /* === ì»¤ìŠ¤í…€ ëª¨ë‹¬ (Confirm) CSS === */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: #fff;
            border-radius: 8px;
            padding: 25px 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
        }
        .modal-content h2 { margin-top: 0; color: #E74C3C; }
        .modal-content p { white-space: pre-line; line-height: 1.6; color: #555; }
        .modal-buttons { margin-top: 25px; }
        .modal-buttons .btn { width: 100px; margin: 0 5px; }
        .btn-confirm { background-color: #E74C3C; }
        .btn-cancel { background-color: #95a5a6; }
    </style>
</head>
<body>

<h1>Ranger OAuth2 ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</h1>

<div>
    <a href="/oauth2/authorization/google"><button class="btn google">Google ë¡œê·¸ì¸</button></a>
    <a href="/oauth2/authorization/naver"><button class="btn naver">Naver ë¡œê·¸ì¸</button></a>
    <a href="/oauth2/authorization/kakao"><button class="btn kakao">Kakao ë¡œê·¸ì¸</button></a>
    <a href="/oauth2/authorization/facebook"><button class="btn facebook">Facebook ë¡œê·¸ì¸</button></a>
</div>

<hr style="margin: 30px auto; width: 70%; border: 0; border-top: 1px solid #eee;">

<div>
    <button class="btn action" onclick="reissueToken()">ğŸ”„ í† í° ì¬ë°œê¸‰</button>
    <button class="btn action" onclick="logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
</div>

<div style="margin-top: 15px;">
    <button class="btn danger" onclick="confirmWithdraw()">ğŸ”¥ íšŒì› íƒˆí‡´</button>
</div>

<div class="status" id="status">ğŸ”’ í˜„ì¬ ë¡œê·¸ì•„ì›ƒ ìƒíƒœì…ë‹ˆë‹¤.</div>

<pre id="result">ğŸ‘‰ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ API ì‘ë‹µ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</pre>

<div id="withdrawSuccess">
    âœ… íšŒì›íƒˆí‡´ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.<br>
    (ì†Œì…œ ì—°ë™ í•´ì œ + DB ì‚­ì œ + í† í° ì°¨ë‹¨ ì™„ë£Œ)
</div>

<div id="confirmModal" class="modal-overlay">
    <div class="modal-content">
        <h2 id="modalTitle">í™•ì¸</h2>
        <p id="modalMessage">ì´ ì‘ì—…ì„ ìˆ˜í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <div class="modal-buttons">
            <button id="modalBtnConfirm" class="btn btn-confirm">í™•ì¸</button>
            <button id="modalBtnCancel" class="btn btn-cancel">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<script>
    // === ì „ì—­ ë³€ìˆ˜ ë° ì´ˆê¸°í™” ===
    const resultEl = document.getElementById('result');
    let onConfirmCallback = null;

    window.onload = function() {
        showStatus();

        // ëª¨ë‹¬ ì´ë²¤íŠ¸ ë°”ì¸ë”©
        document.getElementById('modalBtnCancel').onclick = hideModal;
        document.getElementById('modalBtnConfirm').onclick = () => {
            if (onConfirmCallback) onConfirmCallback();
            hideModal();
        };
    };

    // === ìƒíƒœ í‘œì‹œ í•¨ìˆ˜ ===
    function showStatus() {
      const accessToken = localStorage.getItem('accessToken');
      const refreshToken = localStorage.getItem('refreshToken');
      const statusEl = document.getElementById('status');

      if (accessToken && refreshToken) {
        statusEl.innerText =
          'âœ… ë¡œê·¸ì¸ ìƒíƒœ (í† í° ë³´ìœ  ì¤‘)\n' +
          'User: ' + parseJwt(accessToken) + '\n' +
          'Access Token: ' + accessToken.substring(0, 15) + '...';
        statusEl.style.color = '#27ae60';
      } else {
        statusEl.innerText = 'ğŸ”’ í˜„ì¬ ë¡œê·¸ì•„ì›ƒ ìƒíƒœì…ë‹ˆë‹¤.';
        statusEl.style.color = '#555';
      }
    }

    // JWT ë””ì½”ë”© (ì‚¬ìš©ì ì´ë¦„ í™•ì¸ìš© ë‹¨ìˆœ íŒŒì‹±)
    function parseJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            const payload = JSON.parse(jsonPayload);
            return payload.username || payload.sub;
        } catch (e) {
            return "Unknown";
        }
    }

    // === ëª¨ë‹¬ ì œì–´ ===
    function showModal(title, message, onConfirm) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMessage').innerText = message;
        onConfirmCallback = onConfirm;
        document.getElementById('confirmModal').style.display = 'flex';
    }
    function hideModal() {
        document.getElementById('confirmModal').style.display = 'none';
        onConfirmCallback = null;
    }

    // === 1. í† í° ì¬ë°œê¸‰ ===
    async function reissueToken() {
      const refreshToken = localStorage.getItem('refreshToken');
      if (!refreshToken) {
        resultEl.innerText = 'âŒ ì¬ë°œê¸‰ ì‹¤íŒ¨: Refresh Tokenì´ ì—†ìŠµë‹ˆë‹¤.';
        return;
      }

      resultEl.innerText = 'ğŸ”„ í† í° ì¬ë°œê¸‰ ìš”ì²­ ì¤‘...';

      try {
        const res = await fetch('/auth/refresh', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + localStorage.getItem('accessToken') // í˜¹ì‹œ ëª°ë¼ ë³´ëƒ„
          },
          body: JSON.stringify({ refreshToken })
        });
        const result = await res.json();

        if (res.ok && result.success) {
          localStorage.setItem('accessToken', result.data.accessToken);
          localStorage.setItem('refreshToken', result.data.refreshToken);
          resultEl.innerText = 'âœ… ì¬ë°œê¸‰ ì„±ê³µ!\n' + JSON.stringify(result, null, 2);
          showStatus();
        } else {
          resultEl.innerText = 'âŒ ì¬ë°œê¸‰ ì‹¤íŒ¨: ' + result.message;
        }
      } catch (err) {
        resultEl.innerText = 'âŒ ì˜¤ë¥˜ ë°œìƒ: ' + err.message;
      }
    }

    // === 2. ë¡œê·¸ì•„ì›ƒ ===
    async function logout() {
      const accessToken = localStorage.getItem('accessToken');
      if (!accessToken) {
        resultEl.innerText = 'ğŸ”’ ì´ë¯¸ ë¡œê·¸ì•„ì›ƒ ìƒíƒœì…ë‹ˆë‹¤.';
        return;
      }

      resultEl.innerText = 'ğŸšª ë¡œê·¸ì•„ì›ƒ ìš”ì²­ ì¤‘...';

      try {
        const res = await fetch('/auth/logout', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + accessToken }
        });

        if (res.ok) {
            localStorage.clear();
            resultEl.innerText = 'âœ… ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ (ì„œë²„ ë¸”ë™ë¦¬ìŠ¤íŠ¸ ë“±ë¡ë¨)';
            showStatus();
        } else {
            const result = await res.json();
            resultEl.innerText = 'âŒ ì‹¤íŒ¨: ' + JSON.stringify(result, null, 2);
        }
      } catch (err) {
        resultEl.innerText = 'âŒ ì˜¤ë¥˜ ë°œìƒ: ' + err.message;
      }
    }

    // === 3. íšŒì› íƒˆí‡´ (Confirm) ===
    function confirmWithdraw() {
        const token = localStorage.getItem('accessToken');
        if (!token) {
            resultEl.innerText = 'âš ï¸ ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤.';
            return;
        }
        showModal(
            'ğŸ”¥ íšŒì› íƒˆí‡´ ê²½ê³ ',
            'ì •ë§ë¡œ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê³„ì • ì •ë³´ê°€ ì¦‰ì‹œ ì‚­ì œë˜ë©°,\nì†Œì…œ ì—°ë™ë„ í•´ì œë©ë‹ˆë‹¤.',
            withdrawUser
        );
    }

    // === 4. íšŒì› íƒˆí‡´ (API í˜¸ì¶œ) ===
    async function withdrawUser() {
        const token = localStorage.getItem('accessToken');
        resultEl.innerText = 'ğŸ”¥ íƒˆí‡´ ì²˜ë¦¬ ì¤‘... (ì—°ë™ í•´ì œ & DB ì‚­ì œ)';

        try {
            const res = await fetch('/auth/withdraw', {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            });

            if (res.ok) {
                localStorage.clear();
                showStatus();
                resultEl.innerText = ''; // ê²°ê³¼ì°½ ë¹„ìš°ê¸°
                document.getElementById('withdrawSuccess').style.display = 'block'; // ì„±ê³µ ë°•ìŠ¤ ë³´ì´ê¸°

                // 3ì´ˆ ë’¤ ì„±ê³µ ë°•ìŠ¤ ìˆ¨ê¸°ê¸°
                setTimeout(() => {
                    document.getElementById('withdrawSuccess').style.display = 'none';
                    resultEl.innerText = 'ğŸ‘‰ íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ë³´ì„¸ìš”.';
                }, 3000);
            } else {
                const data = await res.json();
                resultEl.innerText = `âŒ íƒˆí‡´ ì‹¤íŒ¨ (Code: ${res.status}):\n${JSON.stringify(data, null, 2)}`;
            }
        } catch (err) {
            resultEl.innerText = 'âŒ ì„œë²„ í†µì‹  ì˜¤ë¥˜: ' + err.message;
        }
    }
</script>

</body>
</html>
